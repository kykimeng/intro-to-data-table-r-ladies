---
title: "Introduction to `data.table`"
author: "Haema Nilakanta & Kim Ky"
date: "10/10/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

<style type="text/css">

body{ /* Normal  */
      font-size: 14px;
  }
td {  /* Table  */
  font-size: 10px;
}
h1 { /* Header 1 */
  font-size: 26px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 14px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>

___

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(ggplot2)
```

# Overview

### What is `data.table`?

"`data.table` is an R package that provides an enhanced version of `data.frame`s." It provides a faster and more efficient way to do data manipulation. 

### Install and load

```{r,eval=F}
# install 
install.packages("data.table")
# load 
library(data.table)
```

# The Basics

```{r,echo=F, fig.width=10, fig.height=5}
ggplot() + 
  geom_text(aes(x = 0, y = 0, label = "DT[i, j, by]"), size = 16) +
  theme_classic() +
  theme(axis.line = element_blank(), axis.title = element_blank(), 
        axis.text = element_blank(), axis.ticks = element_blank()) +
  geom_line(aes(x = c(-2, -.3), y = c(-2, -0.25)), arrow = arrow(), size = 1) +
  geom_line(aes(x = c(0.15, 0.15), y = c(-2, -0.25)), arrow = arrow(), size = 1) +
  geom_line(aes(x = c(.9, 2), y = c(-.25, -2)), arrow = arrow(ends = "first"), size = 1) +
  geom_label(aes(x = c(-2.5, 0.15, 3), y = -2, label = c("WHERE\n(which rows)", "SELECT\n(do what)", "GROUP BY\n(group by what)")), size = 10) +
  scale_x_continuous(limits = c(-4, 5)) +
  scale_y_continuous(limits = c(-2.2, .5))
```


```{r}
# create a data.table
DT <- data.table(x = c(1, 2, 3), y = c('a', 'b', 'c'))

# turn iris data.frame to a data.table object
data("iris")
iris_dt <- setDT(iris)
# print
iris_dt
```

When a `data.table` has more than 100 rows, it automatically prints the first five and the last five rows. 

Select first 3 rows:

```{r}
# data.frame
iris[1:3,]
# data.table
iris_dt[1:3]
```

Find rows where `Species == "setosa"`:

```{r}
# data.frame
iris[iris$Species == "setosa"]
# data.table
iris_dt[Species == "setosa"]
```

Calculate the mean value of `Sepal.Length`:

```{r}
# data.frame
mean(iris$Sepal.Length)
# data.table
iris_dt[, mean(Sepal.Length)]
```

Calculate mean `Sepal.Length` by `Species`:

```{r}
# data.frame
aggregate(Sepal.Length ~ Species, iris, mean) # no easy way to do this in base R
# data.table
iris_dt[, mean(Sepal.Length), by = .(Species)]
```

Calculate mean `Sepal.Length` by `Species` where `Sepal.Width >= 3`:

```{r}
# data.frame
aggregate(Sepal.Length ~ Species, iris[Sepal.Width >= 3,], mean)
# data.table
iris_dt[Sepal.Width >= 3, .(mean_sepal_length = mean(Sepal.Length)), by = .(Species)]
```

Calculate number of rows:

```{r}
# data.frame
nrow(iris)
# data.table
iris_dt[, .N]
```

Calculate number of unique values for `Species`:

```{r}
# data.frame
length(unique(iris$Species))
# data.table
iris_dt[, uniqueN(Species)]
```

Calculate number of observations by `Species`:

# The Advanced 

*Compare base R and data.table here - more advanced operations*

# So, why should you use `data.table`?

* concise and consistent syntax
    + `DT[i, j, by]`
* speed
    + faster than base R and `dplyr`
* efficient memory usage
    + sub-assign by reference: `DT[x < 0, y := NA]`
    + aggregate while joining: `DT1[DT2, list(z=sum(z)), by = .EACHI]` (equivalent to `DT1[, .(z=sum(z)), keyby=.(x,y)][DT2]`)
* features
    + `fread`, `fwrite`, automatic indexing, rolling joins, non-equivalent joins, etc.

More detail, [here](https://stackoverflow.com/questions/21435339/data-table-vs-dplyr-can-one-do-something-well-the-other-cant-or-does-poorly).


# References

1. Matt Dowle and Arun Srinivasan (2018). `data.table`: Extension of `data.frame`. R
  package version 1.11.4. https://CRAN.R-project.org/package=data.table
2. https://github.com/Rdatatable/data.table/wiki
3. https://stackoverflow.com/questions/21435339/data-table-vs-dplyr-can-one-do-something-well-the-other-cant-or-does-poorly